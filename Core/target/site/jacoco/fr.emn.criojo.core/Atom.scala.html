<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Atom.scala</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Core</a> &gt; <a href="index.html" class="el_package">fr.emn.criojo.core</a> &gt; <span class="el_source">Atom.scala</span></div><h1>Atom.scala</h1><pre class="source lang-java linenums">package fr.emn.criojo.core

import datatype._
import fr.emn.criojo.ext.expression.Relation.constructor.LocalRelation
import Converters._
import fr.emn.criojo.ext.expression.Relation.{ChannelLocation, VarChannel, Relation}

/**
 * Created by IntelliJ IDEA.
 * User: mayleen
 * Date: Jun 9, 2010
 * Time: 5:47:03 PM
 * To change this template use File | Settings | File Templates.
 */

/**
 * The Atom singleton
 * @define THIS Atom
 */
@serializable
<span class="pc" id="L21">object Atom{</span>

<span class="fc" id="L23">  var atomCount = 0</span>

  def nextAtomId():Int = {
<span class="fc" id="L26">    atomCount += 1</span>
<span class="fc" id="L27">    atomCount</span>
  }

<span class="fc" id="L30">  def apply(rn:String, lst:Term*):Atom = new Atom(LocalRelation(rn), lst.toList)</span>
<span class="fc" id="L31">  def apply(rel:Relation, lst:Term*):Atom = new Atom(rel, lst.toList)</span>
}

/**
 * The Atom class
 * @define THIS Atom
 */
//TODO pass relation as parameter in construction
<span class="pc bnc" id="L39" title="All 5 branches missed.">case class Atom(relation:Relation, patterns: List[Term]) {</span>

<span class="fc" id="L41">  var consumed:Boolean = false</span>
//  println(&quot;li:&quot;+Atom.cpt1)
//  Atom.cpt1 += 1
//
//  override def finalize() {
//    Atom.cpt2 -= 1
//    println(&quot;la:&quot;+Atom.cpt2)
//  }

  //def this(relationName:String, patterns:List[Term]) = this(LocalRelation(relationName), patterns)

<span class="pc" id="L52">  var persistent:Boolean = false</span>
<span class="pc" id="L53">  protected var active:Boolean = true</span>

  //TODO Remove this
<span class="nc" id="L56">  def isTrue:Boolean = false</span>
<span class="nc" id="L57">  def isFalse:Boolean = false</span>

<span class="fc" id="L59">  def arity = patterns.size</span>

  @deprecated (&quot;Use: setActive(false)&quot;)
  def inactivate(){
<span class="nc" id="L63">    active = false</span>
  }

<span class="nc" id="L66">  def setActive(active:Boolean) { this.active = active }</span>
<span class="nc" id="L67">  def isActive:Boolean = this.active</span>

<span class="fc bfc" id="L69" title="All 2 branches covered.">  def applyValuation(valuation:Valuation):Atom = new Atom(relation match {</span>
<span class="fc" id="L70">    case varChannel:VarChannel =&gt; ChannelLocationToRelation(varChannel.applyValuation(valuation).asInstanceOf[ChannelLocation])</span>
<span class="fc" id="L71">    case _ =&gt; relation</span>
<span class="fc" id="L72">  }, patterns.map({ pattern:Term =&gt; pattern.applyValuation(valuation).reduce() }))</span>

  /** Applies the given substitutions to the atom.
   *
   * @param vals a Valuation
   * @return an [[fr.emn.criojo.core.Atom]]
   */
  @deprecated(&quot;use: applyValuation&quot;)
<span class="nc" id="L80">  def applySubstitutions(vals:Valuation):Atom = this</span>

  /** Returns true if the given atom correspondsTo this atom.
   *
   * @param that an [[fr.emn.criojo.core.Atom]]
   * @return true if the matching is positive
   */
  def correspondsTo(that: Atom) : Boolean = {
<span class="pc bpc" id="L88" title="3 of 6 branches missed.">      this.relation.name == that.relation.name &amp;&amp;</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">      this.arity == that.arity &amp;&amp;</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">      this.patterns.zip(that.patterns).forall(p =&gt; p._1.matches(p._2.asInstanceOf[Expression]))</span>
  }

  // fixme: le premier atome contient une liste de patterns et le second une list d'expression
  def getValuation(that: Atom):Valuation = {
//    def getVal(t1:Term, t2:Term):Valuation = t2 match {
//      case exp:Expression =&gt; t1.getValuation(exp)
//      case _ =&gt; throw new PatternNotMatchingException
//    }
<span class="fc" id="L99">    def getVal(t1:Pattern, t2:Expression):Valuation = t1.getValuation(t2)</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">    this.patterns.zip(that.patterns).foldLeft(Valuation())((v,p)=&gt;v union getVal(p._1.asInstanceOf[Pattern],p._2.asInstanceOf[Expression]))</span>
  }


  /** Returns true if the given variable is in this atom.
   *
   * @param v a [[fr.emn.criojo.core.datatype.Variable]]
   * @return true if the variable is in the list of patterns
   */
  def hasVariable(v: Variable) = {
<span class="nc" id="L110">    this.patterns.contains(v)</span>
  }

  // constant hashcode
<span class="pc" id="L114">  var id = Atom.nextAtomId()</span>
<span class="fc" id="L115">  override def hashCode = id</span>

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">  override def equals(that: Any):Boolean = that match{</span>
<span class="pc bpc" id="L118" title="3 of 10 branches missed.">    case a:Atom =&gt; this.relation.name == a.relation.name &amp;&amp; this.patterns.zip(a.patterns).forall(p =&gt; p._1 eq  p._2)</span>

<span class="nc" id="L120">    case _ =&gt; false</span>
  }

  override def toString =
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">    (if (active) &quot;&quot; else &quot;-&quot;) +</span>
<span class="fc" id="L125">            relation +</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">            (if (patterns.isEmpty) &quot;&quot; else patterns.mkString(&quot;(&quot;,&quot;,&quot;,&quot;)&quot;))</span>

<span class="fc" id="L128">  override def clone:Atom = new Atom(relation,patterns)</span>
}





</pre><div class="footer"><span class="right">Created with <a href="http://jacoco.org">JaCoCo</a> 0.5.3.201107060350</span></div></body></html>